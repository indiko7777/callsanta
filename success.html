<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Successful - CallSanta.us</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        santa: {
                            red: '#D42426',
                            gold: '#C5A059',
                        }
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-slate-950 text-white min-h-screen flex items-center justify-center p-6">
    <div class="max-w-2xl mx-auto text-center space-y-6">
        <div class="w-20 h-20 bg-green-500 rounded-full flex items-center justify-center mx-auto animate-pulse">
            <i data-lucide="check" class="w-12 h-12 text-white"></i>
        </div>

        <h1 class="text-5xl font-bold text-white">Payment Successful!</h1>

        <p class="text-xl text-gray-300">
            <span id="greeting-message">Thank you for your purchase!</span> Santa is preparing your personalized
            experience.
        </p>

        <!-- CONTAINER FOR CALL/CODE INSTRUCTIONS -->
        <div id="call-fulfillment-container"
            class="bg-slate-900 p-8 rounded-2xl border border-white/10 shadow-2xl space-y-6">

            <h2 id="fulfillment-header" class="text-2xl font-semibold mb-4 text-santa-gold"></h2>

            <!-- --- ACCESS CODE DISPLAY (Visible for Bundle/Call) --- -->
            <div id="code-display-block" class="bg-slate-800/80 p-6 rounded-xl mb-4 border-2 border-santa-red hidden">
                <p class="text-sm text-gray-400 uppercase tracking-widest">Your Private Call Code:</p>
                <p id="access-code-display" class="text-6xl font-mono font-bold text-santa-red animate-pulse-slow">
                    Loading...
                </p>
                <p class="text-sm text-gray-400 mt-3">Call the Santa Hotline at: <span id="hotline-number"
                        class="font-bold text-white">(555) 555-SANTA</span></p>
            </div>

            <!-- --- INSTRUCTIONS LIST (Changes based on package) --- -->
            <ol id="instructions-list" class="text-left space-y-3 text-gray-300 text-lg"></ol>

            <div id="overage-policy" class="text-sm text-gray-300 mb-6">
                <!-- Policy details loaded here by JS -->
            </div>
        </div>

        <!-- VIDEO ONLY INSTRUCTIONS -->
        <div id="video-only-block" class="bg-slate-900 p-8 rounded-2xl border border-white/10 shadow-2xl hidden">
            <h2 class="text-2xl font-semibold text-santa-gold mb-4">Your Video Keepsake is Generating!</h2>

            <!-- Progress Bar Container -->
            <div class="w-full bg-slate-800 rounded-full h-6 mb-4 overflow-hidden border border-white/10 relative">
                <!-- "Sugar Cane" Color Bar (Light Green/Yellowish) -->
                <div id="video-progress-bar"
                    class="bg-[#F9FFF3] h-full rounded-full transition-all duration-1000 ease-out shadow-[0_0_15px_rgba(249,255,243,0.5)]"
                    style="width: 5%"></div>
            </div>

            <p id="video-status-text" class="text-lg text-gray-300 animate-pulse">Santa is checking his list twice...
            </p>
            <p class="text-sm text-gray-500 mt-2">Please stay on this page. This usually takes about 1 minute.</p>
        </div>

        <div id="email-notice" class="bg-santa-red/10 border border-santa-red/30 rounded-xl p-4 mt-6 hidden">
            <p class="text-sm text-gray-300">
                <i data-lucide="check-circle" class="w-4 h-4 inline mr-2"></i>
                <span id="email-notice-text">Your order is confirmed.</span>
            </p>
        </div>

        <a href="/"
            class="inline-block mt-8 px-8 py-4 bg-santa-red hover:bg-red-700 rounded-xl font-semibold text-lg transition-all duration-300 shadow-xl hover:shadow-2xl">
            Return to Home
        </a>
    </div>

    <script>
        lucide.createIcons();

        // --- CONFIGURATION ---
        const GET_ORDER_DETAILS_URL = '/.netlify/functions/get-order-details';
        // NOTE: Replace the number below with the actual Twilio number you purchased
        const TWILIO_PHONE_NUMBER = "+1 (438) 795-1562";

        // --- INSTRUCTION SETS ---
        const INSTRUCTIONS_CALL = `
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">1.</span>
                <span><span class="font-bold">Find a quiet spot</span> with your child and hand them the phone.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">2.</span>
                <span>Dial the Santa Hotline number: <span class="font-bold">${TWILIO_PHONE_NUMBER}</span>.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">3.</span>
                <span>Enter the <span class="font-bold">4-digit Access Code</span> when prompted by Santa's Helper.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">4.</span>
                <span>Experience the magic!</span>
            </li>
        `;
        const INSTRUCTIONS_VIDEO = `
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">1.</span>
                <span>Your personalized video is now rendering at the North Pole.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">2.</span>
                <span><strong>Please wait here</strong> (approx. 1 minute). The video will pop up automatically!</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">3.</span>
                <span>Gather your family, dim the lights, and hit play!</span>
            </li>
        `;

        // --- MAIN FETCH FUNCTION ---
        async function fetchOrderDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const paymentIntentId = urlParams.get('payment_intent');

            const fulfillmentHeader = document.getElementById('fulfillment-header');
            const codeDisplayBlock = document.getElementById('code-display-block');
            const codeDisplay = document.getElementById('access-code-display');
            const overagePolicy = document.getElementById('overage-policy');
            const instructionsList = document.getElementById('instructions-list');
            const greetingMessage = document.getElementById('greeting-message');
            const videoOnlyBlock = document.getElementById('video-only-block');
            const emailDisplay = document.getElementById('email-display');
            const emailListDisplay = document.getElementById('email-list-display');
            const callFulfillmentContainer = document.getElementById('call-fulfillment-container');
            const hotlineNumberDisplay = document.getElementById('hotline-number');
            const emailNotice = document.getElementById('email-notice');
            const emailNoticeText = document.getElementById('email-notice-text');

            // Set the phone number display immediately
            if (hotlineNumberDisplay) hotlineNumberDisplay.innerText = TWILIO_PHONE_NUMBER;

            if (!paymentIntentId) {
                if (fulfillmentHeader) fulfillmentHeader.innerText = "Error: Payment ID Missing.";
                if (codeDisplay) codeDisplay.innerText = "ERROR";
                return;
            }

            try {
                // Try to fetch details from the backend using the Payment Intent ID
                const response = await fetch(`${GET_ORDER_DETAILS_URL}?payment_intent_id=${paymentIntentId}`);

                // If backend function doesn't exist (404), fall back to localStorage
                if (!response.ok) {
                    console.log('Backend function not available, using localStorage fallback');
                    const orderData = localStorage.getItem('lastOrderData');
                    if (orderData) {
                        const data = JSON.parse(orderData);
                        displayOrderDetails(data);
                    } else {
                        if (fulfillmentHeader) fulfillmentHeader.innerText = "Order Details Unavailable";
                        if (codeDisplay) codeDisplay.innerText = "Check your email for access code";
                        if (instructionsList) instructionsList.innerHTML = `
                            <li class="flex items-start gap-3">
                                <span class="text-santa-red font-bold">•</span>
                                <span>Your order was successful! Check your email for your access code.</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-santa-red font-bold">•</span>
                                <span>Call <span class="font-bold">${TWILIO_PHONE_NUMBER}</span> and enter your 4-digit code.</span>
                            </li>
                        `;
                        if (codeDisplayBlock) codeDisplayBlock.classList.remove('hidden');
                        if (callFulfillmentContainer) callFulfillmentContainer.classList.remove('hidden');
                    }
                    return;
                }

                const data = await response.json();

                if (data.error || !data.packageId) {
                    if (fulfillmentHeader) fulfillmentHeader.innerText = "Error: Order not found.";
                    if (codeDisplay) codeDisplay.innerText = "ERROR";
                    console.error("Order lookup failed:", data.error);
                    return;
                }

                displayOrderDetails(data);

            } catch (e) {
                console.error("Network or parsing error:", e);
                // Fallback to localStorage
                const orderData = localStorage.getItem('lastOrderData');
                if (orderData) {
                    const data = JSON.parse(orderData);
                    displayOrderDetails(data);
                } else {
                    if (codeDisplay) codeDisplay.innerText = "Error loading details. Check your email.";
                }
            }
        }

        function displayOrderDetails(data) {
            const fulfillmentHeader = document.getElementById('fulfillment-header');
            const codeDisplayBlock = document.getElementById('code-display-block');
            const codeDisplay = document.getElementById('access-code-display');
            const overagePolicy = document.getElementById('overage-policy');
            const instructionsList = document.getElementById('instructions-list');
            const greetingMessage = document.getElementById('greeting-message');
            const videoOnlyBlock = document.getElementById('video-only-block');
            const emailDisplay = document.getElementById('email-display');
            const callFulfillmentContainer = document.getElementById('call-fulfillment-container');
            const emailNotice = document.getElementById('email-notice');
            const emailNoticeText = document.getElementById('email-notice-text');

            // --- UPDATE GREETING AND EMAIL ---
            if (greetingMessage) greetingMessage.innerHTML = `Thank you, ${data.childName}'s parent!`;
            // Only set emailDisplay if it exists (it's in the static HTML of video-only-block)
            if (emailDisplay) emailDisplay.innerText = data.parentEmail;

            // --- CONDITIONAL FULFILLMENT LOGIC ---
            const isCallPackage = (data.packageId === 'bundle' || data.packageId === 'call');
            const isVideoPackage = (data.packageId === 'bundle' || data.packageId === 'video');

            // Case 1 & 2: Call or Bundle
            if (isCallPackage) {
                // Show Call-specific block and Code
                if (codeDisplayBlock) codeDisplayBlock.classList.remove('hidden');
                if (callFulfillmentContainer) callFulfillmentContainer.classList.remove('hidden');
                if (videoOnlyBlock) videoOnlyBlock.classList.add('hidden');

                if (instructionsList) instructionsList.innerHTML = INSTRUCTIONS_CALL;
                if (codeDisplay) codeDisplay.innerText = data.accessCode;
                if (fulfillmentHeader) fulfillmentHeader.innerText = "Your Live Call Access Code";

                // Overage Policy
                if (overagePolicy) {
                    if (data.overageOption === 'overage_accepted') {
                        overagePolicy.innerHTML = '<strong>Important:</strong> Your call may exceed 5 minutes. You agreed to pay $1.00 USD per minute for time over 5 minutes.';
                    } else {
                        overagePolicy.innerHTML = '<strong>Policy:</strong> Your call will automatically disconnect after 5 minutes to prevent extra charges.';
                    }
                }

                // If it's a Bundle, we also note the video is coming
                if (data.packageId === 'bundle') {
                    if (fulfillmentHeader) fulfillmentHeader.innerText = "Bundle Access: Call Now, Video Arrives Soon";
                    if (emailNotice) emailNotice.classList.remove('hidden');
                    if (emailNoticeText) emailNoticeText.innerText = 'Your confirmation email and video link will be sent to your inbox.';
                }

            }

            // Case 3: Video Only (Must check !isCallPackage to prevent bundle overwriting this)
            if (isVideoPackage && !isCallPackage) {
                // Hide Call-specific block and show Video only block
                if (callFulfillmentContainer) callFulfillmentContainer.classList.add('hidden');
                if (videoOnlyBlock) videoOnlyBlock.classList.remove('hidden');
                if (fulfillmentHeader) fulfillmentHeader.innerText = "Your Video Keepsake is Generating!";

                // Inject the email directly into the string
                const instructionsWithEmail = INSTRUCTIONS_VIDEO.replace('<span id="email-list-display"></span>', `<span class="font-bold">${data.parentEmail}</span>`);
                if (instructionsList) instructionsList.innerHTML = instructionsWithEmail;

                if (overagePolicy) overagePolicy.innerHTML = ''; // Clear policy as it's video only
                if (emailNotice) emailNotice.classList.remove('hidden');
                if (emailNoticeText) emailNoticeText.innerText = 'Your video link will be sent to your inbox shortly.';
            }

            // --- VIDEO POLLING (For Bundle & Video) ---
            if (isVideoPackage) {
                // Show video block if not already shown (for Bundle)
                if (isCallPackage) {
                    if (videoOnlyBlock) {
                        videoOnlyBlock.classList.remove('hidden');
                        // Adjust text for bundle
                        const vHeader = videoOnlyBlock.querySelector('h2');
                        if (vHeader) vHeader.innerText = "Bonus: Your Santa Video is Generating!";
                        // We want to target the description paragraph, not the status text. 
                        // The status text has id="video-status-text".
                        // Let's just append a note or leave the default text which is "Santa is checking his list..."
                        // --- INSTRUCTION SETS ---
                        const INSTRUCTIONS_CALL = `
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">1.</span>
                <span><span class="font-bold">Find a quiet spot</span> with your child and hand them the phone.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">2.</span>
                <span>Dial the Santa Hotline number: <span class="font-bold">${TWILIO_PHONE_NUMBER}</span>.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">3.</span>
                <span>Enter the <span class="font-bold">4-digit Access Code</span> when prompted by Santa's Helper.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">4.</span>
                <span>Experience the magic!</span>
            </li>
        `;
                        const INSTRUCTIONS_VIDEO = `
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">1.</span>
                <span>Your personalized video is now rendering at the North Pole.</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">2.</span>
                <span><strong>Please wait here</strong> (approx. 1 minute). The video will pop up automatically!</span>
            </li>
            <li class="flex items-start gap-3">
                <span class="text-santa-red font-bold">3.</span>
                <span>Gather your family, dim the lights, and hit play!</span>
            </li>
        `;

                        // --- MAIN FETCH FUNCTION ---
                        async function fetchOrderDetails() {
                            const urlParams = new URLSearchParams(window.location.search);
                            const paymentIntentId = urlParams.get('payment_intent');

                            const fulfillmentHeader = document.getElementById('fulfillment-header');
                            const codeDisplayBlock = document.getElementById('code-display-block');
                            const codeDisplay = document.getElementById('access-code-display');
                            const overagePolicy = document.getElementById('overage-policy');
                            const instructionsList = document.getElementById('instructions-list');
                            const greetingMessage = document.getElementById('greeting-message');
                            const videoOnlyBlock = document.getElementById('video-only-block');
                            const emailDisplay = document.getElementById('email-display');
                            const emailListDisplay = document.getElementById('email-list-display');
                            const callFulfillmentContainer = document.getElementById('call-fulfillment-container');
                            const hotlineNumberDisplay = document.getElementById('hotline-number');
                            const emailNotice = document.getElementById('email-notice');
                            const emailNoticeText = document.getElementById('email-notice-text');

                            // Set the phone number display immediately
                            if (hotlineNumberDisplay) hotlineNumberDisplay.innerText = TWILIO_PHONE_NUMBER;

                            if (!paymentIntentId) {
                                if (fulfillmentHeader) fulfillmentHeader.innerText = "Error: Payment ID Missing.";
                                if (codeDisplay) codeDisplay.innerText = "ERROR";
                                return;
                            }

                            try {
                                // Try to fetch details from the backend using the Payment Intent ID
                                const response = await fetch(`${GET_ORDER_DETAILS_URL}?payment_intent_id=${paymentIntentId}`);

                                // If backend function doesn't exist (404), fall back to localStorage
                                if (!response.ok) {
                                    console.log('Backend function not available, using localStorage fallback');
                                    const orderData = localStorage.getItem('lastOrderData');
                                    if (orderData) {
                                        const data = JSON.parse(orderData);
                                        displayOrderDetails(data);
                                    } else {
                                        if (fulfillmentHeader) fulfillmentHeader.innerText = "Order Details Unavailable";
                                        if (codeDisplay) codeDisplay.innerText = "Check your email for access code";
                                        if (instructionsList) instructionsList.innerHTML = `
                            <li class="flex items-start gap-3">
                                <span class="text-santa-red font-bold">•</span>
                                <span>Your order was successful! Check your email for your access code.</span>
                            </li>
                            <li class="flex items-start gap-3">
                                <span class="text-santa-red font-bold">•</span>
                                <span>Call <span class="font-bold">${TWILIO_PHONE_NUMBER}</span> and enter your 4-digit code.</span>
                            </li>
                        `;
                                        if (codeDisplayBlock) codeDisplayBlock.classList.remove('hidden');
                                        if (callFulfillmentContainer) callFulfillmentContainer.classList.remove('hidden');
                                    }
                                    return;
                                }

                                const data = await response.json();

                                if (data.error || !data.packageId) {
                                    if (fulfillmentHeader) fulfillmentHeader.innerText = "Error: Order not found.";
                                    if (codeDisplay) codeDisplay.innerText = "ERROR";
                                    console.error("Order lookup failed:", data.error);
                                    return;
                                }

                                displayOrderDetails(data);

                            } catch (e) {
                                console.error("Network or parsing error:", e);
                                // Fallback to localStorage
                                const orderData = localStorage.getItem('lastOrderData');
                                if (orderData) {
                                    const data = JSON.parse(orderData);
                                    displayOrderDetails(data);
                                } else {
                                    if (codeDisplay) codeDisplay.innerText = "Error loading details. Check your email.";
                                }
                            }
                        }

                        function displayOrderDetails(data) {
                            const fulfillmentHeader = document.getElementById('fulfillment-header');
                            const codeDisplayBlock = document.getElementById('code-display-block');
                            const codeDisplay = document.getElementById('access-code-display');
                            const overagePolicy = document.getElementById('overage-policy');
                            const instructionsList = document.getElementById('instructions-list');
                            const greetingMessage = document.getElementById('greeting-message');
                            const videoOnlyBlock = document.getElementById('video-only-block');
                            const emailDisplay = document.getElementById('email-display');
                            const callFulfillmentContainer = document.getElementById('call-fulfillment-container');
                            const emailNotice = document.getElementById('email-notice');
                            const emailNoticeText = document.getElementById('email-notice-text');

                            // --- UPDATE GREETING AND EMAIL ---
                            if (greetingMessage) greetingMessage.innerHTML = `Thank you, ${data.childName}'s parent!`;
                            // Only set emailDisplay if it exists (it's in the static HTML of video-only-block)
                            if (emailDisplay) emailDisplay.innerText = data.parentEmail;

                            // --- CONDITIONAL FULFILLMENT LOGIC ---
                            const isCallPackage = (data.packageId === 'bundle' || data.packageId === 'call');
                            const isVideoPackage = (data.packageId === 'bundle' || data.packageId === 'video');

                            // Case 1 & 2: Call or Bundle
                            if (isCallPackage) {
                                // Show Call-specific block and Code
                                if (codeDisplayBlock) codeDisplayBlock.classList.remove('hidden');
                                if (callFulfillmentContainer) callFulfillmentContainer.classList.remove('hidden');
                                if (videoOnlyBlock) videoOnlyBlock.classList.add('hidden');

                                if (instructionsList) instructionsList.innerHTML = INSTRUCTIONS_CALL;
                                if (codeDisplay) codeDisplay.innerText = data.accessCode;
                                if (fulfillmentHeader) fulfillmentHeader.innerText = "Your Live Call Access Code";

                                // Overage Policy
                                if (overagePolicy) {
                                    if (data.overageOption === 'overage_accepted') {
                                        overagePolicy.innerHTML = '<strong>Important:</strong> Your call may exceed 5 minutes. You agreed to pay $1.00 USD per minute for time over 5 minutes.';
                                    } else {
                                        overagePolicy.innerHTML = '<strong>Policy:</strong> Your call will automatically disconnect after 5 minutes to prevent extra charges.';
                                    }
                                }

                                // If it's a Bundle, we also note the video is coming
                                if (data.packageId === 'bundle') {
                                    if (fulfillmentHeader) fulfillmentHeader.innerText = "Bundle Access: Call Now, Video Arrives Soon";
                                    if (emailNotice) emailNotice.classList.remove('hidden');
                                    if (emailNoticeText) emailNoticeText.innerText = 'Your confirmation email and video link will be sent to your inbox.';
                                }

                            }

                            // Case 3: Video Only (Must check !isCallPackage to prevent bundle overwriting this)
                            if (isVideoPackage && !isCallPackage) {
                                // Hide Call-specific block and show Video only block
                                if (callFulfillmentContainer) callFulfillmentContainer.classList.add('hidden');
                                if (videoOnlyBlock) videoOnlyBlock.classList.remove('hidden');
                                if (fulfillmentHeader) fulfillmentHeader.innerText = "Your Video Keepsake is Generating!";

                                // Inject the email directly into the string
                                const instructionsWithEmail = INSTRUCTIONS_VIDEO.replace('<span id="email-list-display"></span>', `<span class="font-bold">${data.parentEmail}</span>`);
                                if (instructionsList) instructionsList.innerHTML = instructionsWithEmail;

                                if (overagePolicy) overagePolicy.innerHTML = ''; // Clear policy as it's video only
                                if (emailNotice) emailNotice.classList.remove('hidden');
                                if (emailNoticeText) emailNoticeText.innerText = 'Your video link will be sent to your inbox shortly.';
                            }

                            // --- VIDEO POLLING (For Bundle & Video) ---
                            if (isVideoPackage) {
                                // Show video block if not already shown (for Bundle)
                                if (isCallPackage) {
                                    if (videoOnlyBlock) {
                                        videoOnlyBlock.classList.remove('hidden');
                                        // Adjust text for bundle
                                        const vHeader = videoOnlyBlock.querySelector('h2');
                                        if (vHeader) vHeader.innerText = "Bonus: Your Santa Video is Generating!";
                                        // We want to target the description paragraph, not the status text. 
                                        // The status text has id="video-status-text".
                                        // Let's just append a note or leave the default text which is "Santa is checking his list..."
                                    }
                                }

                                startVideoPolling(data.order_id || getOrderIdFromUrl());
                            }
                        }

                        function getOrderIdFromUrl() {
                            return null;
                        }

                        async function startVideoPolling(orderId) {
                            if (!orderId) {
                                console.warn("No order ID available for confirmation email.");
                                return;
                            }

                            const videoBlock = document.getElementById('video-only-block');
                            if (!videoBlock) return;

                            const statusHeader = videoBlock.querySelector('h2');
                            const statusText = document.getElementById('video-status-text');
                            const progressBar = document.getElementById('video-progress-bar');

                            // Hide progress bar as it's no longer generating automatically
                            if (progressBar && progressBar.parentElement) {
                                progressBar.parentElement.style.display = 'none';
                            }

                            // Update UI immediately
                            if (statusHeader) statusHeader.innerText = "Order Confirmed!";
                            if (statusText) {
                                statusText.innerText = "Santa has received your request. Your video is being created manually and will be emailed to you soon.";
                                statusText.classList.remove('animate-pulse');
                            }

                            // Trigger Confirmation Email
                            try {
                                const response = await fetch('/.netlify/functions/send-confirmation-email', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ order_id: orderId })
                                });
                                const data = await response.json();
                                console.log("Email confirmation status:", data);
                            } catch (e) {
                                console.error("Error sending confirmation email:", e);
                            }
                        }

                        document.addEventListener('DOMContentLoaded', fetchOrderDetails);
    </script>
</body>

</html>